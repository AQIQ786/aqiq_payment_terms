[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 1,
  "modified": "2024-06-19 11:17:51.150725",
  "module": "Aqiq Payment Terms",
  "name": "Sales order terms",
  "script": "frappe.ui.form.on('Sales Order', {\n    refresh: function(frm) {\n        console.log('Form refreshed');\n    },\n    custom_update_payment_schedule: function(frm) {\n        console.log('Custom update payment schedule triggered');\n        fetchAndPopulatePaymentTerms(frm);\n    },\n    fetch_and_populate_payment_terms: function(frm) {\n        console.log('Fetching and populating payment terms');\n        fetchAndPopulatePaymentTerms(frm);\n    },\n    // Trigger on form save\n    on_submit: function(frm) {\n        console.log('Form submitted');\n        fetchAndPopulatePaymentTerms(frm);\n    }\n});\n\nfunction fetchAndPopulatePaymentTerms(frm) {\n    // Prepare arguments for backend function call\n    let args = {\n        payment_method: frm.doc.custom_payment_method,\n        payment_period_in_months: frm.doc.custom_payment_period_in_months || 0,\n        monthly_payment: frm.doc.custom_monthly_payment || 0,\n        terms_template: frm.doc.terms_template || '',\n        posting_date: frm.doc.transaction_date, // Use transaction date for deposit due date\n        start_date: frm.doc.custom_start_date || '',\n        period_frequency: parseInt(frm.doc.custom_period_frequency || 0),\n        grand_total: parseFloat(frm.doc.grand_total),\n        base_grand_total: parseFloat(frm.doc.base_grand_total),\n        deposit_amount: parseFloat(frm.doc.custom_deposit_amount || 0),\n        bill_date: frm.doc.bill_date || ''\n    };\n\n    // Call the backend function to get payment terms\n    frappe.call({\n        method: 'aqiq_payment_terms.services.rest.get_payment_terms_customized',\n        args: args,\n        callback: function(r) {\n            if (r.message) {\n                console.log('Received payment terms:', r.message);\n\n                // Clear the existing child table\n                frm.clear_table('payment_schedule');\n\n                // Populate the payment schedule child table with the fetched data\n                r.message.forEach(function(term) {\n                    var child = frm.add_child('payment_schedule');\n                    frappe.model.set_value(child.doctype, child.name, 'description', term.description);\n                    frappe.model.set_value(child.doctype, child.name, 'invoice_portion', term.invoice_portion);\n                    frappe.model.set_value(child.doctype, child.name, 'payment_amount', term.payment_amount);\n                    frappe.model.set_value(child.doctype, child.name, 'base_payment_amount', term.base_payment_amount);\n                    frappe.model.set_value(child.doctype, child.name, 'discount_type', term.discount_type);\n                    frappe.model.set_value(child.doctype, child.name, 'discount', term.discount);\n                    frappe.model.set_value(child.doctype, child.name, 'outstanding', term.outstanding);\n                    frappe.model.set_value(child.doctype, child.name, 'mode_of_payment', term.mode_of_payment);\n                    frappe.model.set_value(child.doctype, child.name, 'due_date', term.due_date);\n                    frappe.model.set_value(child.doctype, child.name, 'discount_date', term.discount_date);\n                });\n\n                // Refresh the child table field\n                frm.refresh_field('payment_schedule');\n                console.log('Payment schedule updated');\n            }\n        }\n    });\n}",
  "view": "Form"
 }
]